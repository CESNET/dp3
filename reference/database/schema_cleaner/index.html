
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Dynamic Profile Processing Platform">
      
      
      
        <link rel="canonical" href="https://cesnet.github.io/dp3/reference/database/schema_cleaner/">
      
      
        <link rel="prev" href="../magic/">
      
      
        <link rel="next" href="../snapshots/">
      
      
      <link rel="icon" href="../../../img/dp3-favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>schema_cleaner - DP3</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/slate.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dp3.database.schema_cleaner" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DP3" class="md-header__button md-logo" aria-label="DP3" data-md-component="logo">
      
  <img src="../../../img/dp3-logo-min.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DP3
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              schema_cleaner
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/CESNET/dp3" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    CESNET/dp3
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="DP3" class="md-nav__button md-logo" aria-label="DP3" data-md-component="logo">
      
  <img src="../../../img/dp3-logo-min.svg" alt="logo">

    </a>
    DP3
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CESNET/dp3" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    CESNET/dp3
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../history_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History Management
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../configuration/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/db_entities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database entities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/lifetimes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entity Lifetimes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/event_logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/history_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/processing_core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Processing core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/garbage_collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Garbage Collector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Updater
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Code Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    dp3
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            dp3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    api
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1" id="__nav_9_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1">
            <span class="md-nav__icon md-icon"></span>
            api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/internal/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    internal
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1_1" id="__nav_9_1_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            internal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/dp_logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dp_logger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/entity_response_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entity_response_models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/response_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    response_models
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    main
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/routers/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    routers
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1_3" id="__nav_9_1_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            routers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/entity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/root/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    root
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/telemetry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    telemetry
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../bin/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    bin
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_2" id="__nav_9_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_2">
            <span class="md-nav__icon md-icon"></span>
            bin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    api
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/check/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    check
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/schema_update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    schema_update
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    worker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../common/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    common
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_3" id="__nav_9_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_3">
            <span class="md-nav__icon md-icon"></span>
            common
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/attrspec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    attrspec
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/base_module/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    base_module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/callback_registrar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    callback_registrar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/datapoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datapoint
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/datatype/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datatype
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/entityspec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entityspec
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/mac_address/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mac_address
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/scheduler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    scheduler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/task/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../core/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    core
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_4" id="__nav_9_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_4">
            <span class="md-nav__icon md-icon"></span>
            core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    collector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/link_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    link_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    updater
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    database
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_5" id="__nav_9_1_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1_5">
            <span class="md-nav__icon md-icon"></span>
            database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../encodings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    encodings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../magic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    magic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    schema_cleaner
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    schema_cleaner
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner" class="md-nav__link">
    <span class="md-ellipsis">
      SchemaCleaner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SchemaCleaner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_current_schema_doc" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_schema_doc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.safe_update_schema" class="md-nav__link">
    <span class="md-ellipsis">
      safe_update_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_schema_status" class="md-nav__link">
    <span class="md-ellipsis">
      get_schema_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.detect_changes" class="md-nav__link">
    <span class="md-ellipsis">
      detect_changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.infer_current_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_current_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc" class="md-nav__link">
    <span class="md-ellipsis">
      construct_schema_doc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_entity_types" class="md-nav__link">
    <span class="md-ellipsis">
      construct_entity_types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.await_updated" class="md-nav__link">
    <span class="md-ellipsis">
      await_updated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_index_name_by_keys" class="md-nav__link">
    <span class="md-ellipsis">
      get_index_name_by_keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.update_storage" class="md-nav__link">
    <span class="md-ellipsis">
      update_storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate" class="md-nav__link">
    <span class="md-ellipsis">
      migrate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_2_to_3" class="md-nav__link">
    <span class="md-ellipsis">
      migrate_schema_2_to_3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_3_to_4" class="md-nav__link">
    <span class="md-ellipsis">
      migrate_schema_3_to_4
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../history_management/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    history_management
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_6" id="__nav_9_1_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6">
            <span class="md-nav__icon md-icon"></span>
            history_management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../history_management/history_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    history_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../history_management/telemetry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    telemetry
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../scripts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    scripts
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_7" id="__nav_9_1_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_7">
            <span class="md-nav__icon md-icon"></span>
            scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/add_hashes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    add_hashes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/add_min_t2s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    add_min_t2s
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/datapoint_log_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datapoint_log_converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/dummy_sender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dummy_sender
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/migrate_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    migrate_snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/script_runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    script_runner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../snapshots/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    snapshots
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_8" id="__nav_9_1_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_8">
            <span class="md-nav__icon md-icon"></span>
            snapshots
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snapshots/snapshooter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snapshooter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snapshots/snapshot_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snapshot_hooks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../task_processing/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    task_processing
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_9" id="__nav_9_1_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_9">
            <span class="md-nav__icon md-icon"></span>
            task_processing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_distributor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_distributor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_executor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_hooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_queue
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    worker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scripts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../grafana_plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grafana plugin
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extending Documentation
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner" class="md-nav__link">
    <span class="md-ellipsis">
      SchemaCleaner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SchemaCleaner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_current_schema_doc" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_schema_doc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.safe_update_schema" class="md-nav__link">
    <span class="md-ellipsis">
      safe_update_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_schema_status" class="md-nav__link">
    <span class="md-ellipsis">
      get_schema_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.detect_changes" class="md-nav__link">
    <span class="md-ellipsis">
      detect_changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.infer_current_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_current_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc" class="md-nav__link">
    <span class="md-ellipsis">
      construct_schema_doc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_entity_types" class="md-nav__link">
    <span class="md-ellipsis">
      construct_entity_types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.await_updated" class="md-nav__link">
    <span class="md-ellipsis">
      await_updated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.get_index_name_by_keys" class="md-nav__link">
    <span class="md-ellipsis">
      get_index_name_by_keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.update_storage" class="md-nav__link">
    <span class="md-ellipsis">
      update_storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate" class="md-nav__link">
    <span class="md-ellipsis">
      migrate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_2_to_3" class="md-nav__link">
    <span class="md-ellipsis">
      migrate_schema_2_to_3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_3_to_4" class="md-nav__link">
    <span class="md-ellipsis">
      migrate_schema_3_to_4
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div class="doc doc-object doc-module">



<h1 id="dp3.database.schema_cleaner" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">dp3.database.schema_cleaner</span>


<a href="#dp3.database.schema_cleaner" class="headerlink" title="Permanent link">&para;</a></h1>

    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="dp3.database.schema_cleaner.SchemaCleaner" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SchemaCleaner</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">SchemaCleaner</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">schema_col</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">HierarchicalDict</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


        <p>Maintains a history of <code>model_spec</code> defined schema, updates the database when needed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>db</code>
            </td>
            <td>
                  <code><span title="pymongo.database.Database">Database</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target database mapping. (not just a database connection)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema_col</code>
            </td>
            <td>
                  <code><span title="pymongo.collection.Collection">Collection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection where schema history is stored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_spec</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelSpec (dp3.common.config.ModelSpec)" href="../../common/config/#dp3.common.config.ModelSpec">ModelSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model specification.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="logging.Logger" href="https://docs.python.org/3/library/logging.html#logging.Logger">Logger</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger instance to serve as parent. If not provided, a new logger will be created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">schema_col</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">HierarchicalDict</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">log</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="p">):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;SchemaCleaner&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;SchemaCleaner&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span> <span class="o">=</span> <span class="n">model_spec</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span> <span class="o">=</span> <span class="n">schema_col</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;database.storage.snapshot_bucket_size&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="p">}</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_schema_2_to_3</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_schema_3_to_4</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.get_current_schema_doc" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_current_schema_doc</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.get_current_schema_doc" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_current_schema_doc</span><span class="p">(</span><span class="n">infer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>infer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to infer the schema if it is not found in the database.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    Current schema</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_current_schema_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        infer: Whether to infer the schema if it is not found in the database.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Current schema</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">schema_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="o">.</span><span class="n">find_one</span><span class="p">({},</span> <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)])</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">if</span> <span class="n">schema_doc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">infer</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No schema found, inferring initial schema from database&quot;</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_current_schema</span><span class="p">()</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">entity_id_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_entity_types</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">schema_doc</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="s2">&quot;entity_id_types&quot;</span><span class="p">:</span> <span class="n">entity_id_types</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="s2">&quot;storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">SCHEMA_VERSION</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="p">}</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">return</span> <span class="n">schema_doc</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.safe_update_schema" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">safe_update_schema</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.safe_update_schema" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">safe_update_schema</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Checks whether schema saved in database is up-to-date and updates it if necessary.</p>
<p>Will NOT perform any changes in master collections on conflicting model changes,
but will raise an exception instead.
Any such changes must be performed via the CLI.</p>
<p>As this method modifies the schema collection, it should be called only by the main worker.</p>
<p>The schema collection format is as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>    <span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">entity_id_types</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>            <span class="o">&lt;</span><span class="n">entity_type</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">entity_id_type</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>            <span class="o">...</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="p">},</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>  <span class="c1"># (1)!</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="s2">&quot;storage&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="p">},</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="p">}</span>
</code></pre></div>
<ol>
<li>see <a class="autorefs autorefs-internal" title="construct_schema_doc" href="#dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc">schema construction</a></li>
</ol>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If conflicting changes are detected.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="k">def</span><span class="w"> </span><span class="nf">safe_update_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Checks whether schema saved in database is up-to-date and updates it if necessary.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Will NOT perform any changes in master collections on conflicting model changes,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    but will raise an exception instead.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Any such changes must be performed via the CLI.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    As this method modifies the schema collection, it should be called only by the main worker.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    The schema collection format is as follows:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    ```py</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        {</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">            &quot;_id&quot;: int,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">            entity_id_types: {</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">                &lt;entity_type&gt;: &lt;entity_id_type&gt;,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">                ...</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            },</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">            &quot;schema&quot;: { ... },  # (1)!</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">            &quot;storage&quot;: {</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">                &quot;snapshot_bucket_size&quot;: int</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            },</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">            &quot;version&quot;: int</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        }</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    ```</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    1. see [schema construction][dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc]</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        ValueError: If conflicting changes are detected.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">db_schema</span><span class="p">,</span> <span class="n">config_schema</span><span class="p">,</span> <span class="n">eid_updates</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">deleted_entites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_status</span><span class="p">()</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">if</span> <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="s2">&quot;Schema version mismatch: </span><span class="si">%s</span><span class="s2"> (DB) != </span><span class="si">%s</span><span class="s2"> (config)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_on_conflict</span><span class="p">()</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">if</span> <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="s2">&quot;DB storage settings mismatch: </span><span class="si">%s</span><span class="s2"> (DB) != </span><span class="si">%s</span><span class="s2"> (config)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">],</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">],</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_on_conflict</span><span class="p">()</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">if</span> <span class="n">eid_updates</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">eid_updates</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="s2">&quot;Entity ID type mismatch for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (DB) -&gt; </span><span class="si">%s</span><span class="s2"> (config)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">entity</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;entity_id_types&quot;</span><span class="p">][</span><span class="n">entity</span><span class="p">],</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;entity_id_types&quot;</span><span class="p">][</span><span class="n">entity</span><span class="p">],</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_on_conflict</span><span class="p">()</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">if</span> <span class="n">db_schema</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">config_schema</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema OK!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="n">updates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">deleted_entites</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">config_schema</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated schema, OK now!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_on_conflict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.get_schema_status" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_schema_status</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.get_schema_status" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_schema_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Gets the current schema status.
<code>database_schema</code> is the schema document from the database.
<code>configuration_schema</code> is the schema document constructed from the current configuration.
<code>updates</code> is a dictionary of required updates to each entity.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (<code>database_schema</code>, <code>configuration_schema</code>, <code>updates</code>, <code>deleted_entites</code>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_schema_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Gets the current schema status.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    `database_schema` is the schema document from the database.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    `configuration_schema` is the schema document constructed from the current configuration.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    `updates` is a dictionary of required updates to each entity.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Tuple of (`database_schema`, `configuration_schema`, `updates`, `deleted_entites`).</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">schema_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_schema_doc</span><span class="p">(</span><span class="n">infer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">current_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_schema_doc</span><span class="p">()</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">current_entity_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_entity_types</span><span class="p">()</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">new_schema</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">schema_doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="s2">&quot;entity_id_types&quot;</span><span class="p">:</span> <span class="n">current_entity_types</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">current_schema</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="s2">&quot;storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">SCHEMA_VERSION</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="p">}</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="k">if</span> <span class="n">schema_doc</span> <span class="o">==</span> <span class="n">new_schema</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">return</span> <span class="n">schema_doc</span><span class="p">,</span> <span class="n">schema_doc</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">new_schema</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">eid_updates</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">deleted_entites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_changes</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">schema_doc</span><span class="p">,</span> <span class="n">current_entity_types</span><span class="p">,</span> <span class="n">current_schema</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">return</span> <span class="n">schema_doc</span><span class="p">,</span> <span class="n">new_schema</span><span class="p">,</span> <span class="n">eid_updates</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">deleted_entites</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.detect_changes" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">detect_changes</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.detect_changes" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">detect_changes</span><span class="p">(</span><span class="n">db_schema_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_entity_types</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Detects changes between configured schema and the one saved in the database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>db_schema_doc</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema document from the database.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_entity_types</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Entity ID types from the configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_schema</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema from the configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of required updates to each entity and list of deleted entites.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="k">def</span><span class="w"> </span><span class="nf">detect_changes</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">db_schema_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_entity_types</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_schema</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">    Detects changes between configured schema and the one saved in the database.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        db_schema_doc: Schema document from the database.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        current_entity_types: Entity ID types from the configuration.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        current_schema: Schema from the configuration.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        Tuple of required updates to each entity and list of deleted entites.</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="k">if</span> <span class="n">db_schema_doc</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SCHEMA_VERSION</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema version changed, skipping detecting changes.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">return</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">eid_updates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">id_type</span> <span class="ow">in</span> <span class="n">db_schema_doc</span><span class="p">[</span><span class="s2">&quot;entity_id_types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">if</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_schema</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema breaking change: Entity </span><span class="si">%s</span><span class="s2"> was deleted&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="k">continue</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="k">if</span> <span class="n">id_type</span> <span class="o">!=</span> <span class="n">current_entity_types</span><span class="p">[</span><span class="n">entity</span><span class="p">]:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="s2">&quot;Schema breaking change: Entity </span><span class="si">%s</span><span class="s2"> ID type changed: </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">entity</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">id_type</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">current_entity_types</span><span class="p">[</span><span class="n">entity</span><span class="p">],</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">eid_updates</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$drop&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">if</span> <span class="n">db_schema_doc</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_schema</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">return</span> <span class="n">eid_updates</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[]</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">deleted_entites</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">db_schema_doc</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="c1"># Unset deleted entities</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">if</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_schema</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema breaking change: Entity </span><span class="si">%s</span><span class="s2"> was deleted&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">deleted_entites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="k">continue</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">entity_updates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">current_attributes</span> <span class="o">=</span> <span class="n">current_schema</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="c1"># Unset deleted attributes</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_attributes</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema breaking change: Attribute </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> was deleted&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="n">entity_updates</span><span class="p">[</span><span class="s2">&quot;$unset&quot;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="k">continue</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">current_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">ref</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                    <span class="s2">&quot;Schema breaking change: &#39;</span><span class="si">%s</span><span class="s2">&#39; of </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> changed: </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="n">key</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="n">entity</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                    <span class="n">attr</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                    <span class="n">val</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                    <span class="n">ref</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                <span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="n">entity_updates</span><span class="p">[</span><span class="s2">&quot;$unset&quot;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="k">if</span> <span class="n">entity_updates</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">updates</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_updates</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="k">return</span> <span class="n">eid_updates</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">deleted_entites</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.infer_current_schema" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">infer_current_schema</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.infer_current_schema" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">infer_current_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Infers schema from current database state.</p>
<p>Will detect the attribute type, i.e. whether it is
a plain, timeseries or observations attribute.</p>
<p>All other properties will be set based on configuration.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with inferred schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="k">def</span><span class="w"> </span><span class="nf">infer_current_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    Infers schema from current database state.</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    Will detect the attribute type, i.e. whether it is</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    a plain, timeseries or observations attribute.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    All other properties will be set based on configuration.</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        Dictionary with inferred schema.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">list_collections</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^[^#]+#master$&quot;</span><span class="p">}})</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="n">entities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">entity</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inferring schema for &#39;</span><span class="si">%s</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Testing attributes for history&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="p">[</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="c1"># Get each attribute as a separate document</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$objectToArray&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                <span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$items&quot;</span><span class="p">},</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="c1"># Check if attribute has history</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$isArray&quot;</span><span class="p">:</span> <span class="s2">&quot;$items.v&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="c1"># Group by attribute name</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$items.k&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$addToSet&quot;</span><span class="p">:</span> <span class="s2">&quot;$array&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="c1"># Filter out non-attribute properties</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="n">ID_REGEX</span><span class="p">}}},</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^(?!_id$)&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="p">]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">attributes</span> <span class="o">=</span> <span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">undecided</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">if</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;array&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="kc">False</span><span class="p">]:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">attributes</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">PLAIN</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="k">elif</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;array&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="kc">True</span><span class="p">]:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="n">attributes</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">TIMESERIES</span><span class="o">.</span><span class="n">value</span> <span class="o">|</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">OBSERVATIONS</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="p">}</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="n">undecided</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown attribute type: </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">undecided</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="k">continue</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Testing observations&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="p">[</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="c1"># Get each attribute as a separate document</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$objectToArray&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                <span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$items&quot;</span><span class="p">},</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                <span class="c1"># Check if attribute has confidence (i.e. is observation)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;items.k&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">undecided</span><span class="p">},</span> <span class="s2">&quot;items.v.c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}},</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                <span class="c1"># Group by attribute name</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$items.k&quot;</span><span class="p">}},</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="p">]</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">attributes</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">OBSERVATIONS</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="n">undecided</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">undecided</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="k">continue</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Testing timeseries&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="p">[</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="c1"># Get each attribute as a separate document</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$objectToArray&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">}}},</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$items&quot;</span><span class="p">},</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="c1"># Check if attribute has no confidence (i.e. is timeseries)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="p">{</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                    <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                        <span class="s2">&quot;items.k&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">undecided</span><span class="p">},</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                        <span class="s2">&quot;items.v.c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                        <span class="s2">&quot;items.v.0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                    <span class="p">}</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                <span class="p">},</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="c1"># Group by attribute name</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$items.k&quot;</span><span class="p">}},</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="n">attributes</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">TIMESERIES</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="n">undecided</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">undecided</span><span class="p">:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="k">continue</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Resolving undecided attributes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">undecided</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">undecided</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="n">config_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Assuming configuration type correct for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_spec</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                <span class="n">config_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="n">config_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_spec_dict</span><span class="p">(</span><span class="n">config_spec</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="n">config_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inferred schema for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">construct_schema_doc</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_schema_doc" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">construct_schema_doc</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Constructs schema document from current schema configuration.</p>
<p>The schema document format is as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>    <span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>        <span class="s2">&quot;entity_type&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>            <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                <span class="s2">&quot;data_type&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">data_type</span><span class="o">.</span><span class="n">type_info</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                <span class="s2">&quot;timeseries_type&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">timeseries_type</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                <span class="s2">&quot;series&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">data_type</span><span class="o">.</span><span class="n">type_info</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>            <span class="p">}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="p">}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="p">}</span>
</code></pre></div>
<p>where <code>t</code> is <a class="autorefs autorefs-internal" title="AttrType" href="../../common/attrspec/#dp3.common.attrspec.AttrType">attribute type</a>,
and <code>data_type</code> is the data type string.
<code>timeseries_type</code> is one of <code>regular</code>, <code>irregular</code> or <code>irregular_intervals</code>.
<code>series</code> is a dictionary of series names and their data types.</p>
<p><code>timeseries_type</code> and <code>series</code> are present only for timeseries attributes,
<code>data_type</code> is present only for plain and observations attributes.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_schema_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">    Constructs schema document from current schema configuration.</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">    The schema document format is as follows:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="sd">    ```py</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">        {</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="sd">            &quot;entity_type&quot;: {</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">                &quot;attribute&quot;: {</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="sd">                    &quot;t&quot;: 1 | 2 | 4,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="sd">                    &quot;data_type&quot;: &lt;data_type.type_info&gt; | None</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">                    &quot;timeseries_type&quot;: &lt;timeseries_type&gt; | None</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">                    &quot;series&quot;: dict[str, &lt;data_type.type_info&gt;] | None</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">                }</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="sd">            }</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">        }</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">    ```</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">    where `t` is [attribute type][dp3.common.attrspec.AttrType],</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">    and `data_type` is the data type string.</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">    `timeseries_type` is one of `regular`, `irregular` or `irregular_intervals`.</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">    `series` is a dictionary of series names and their data types.</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">    `timeseries_type` and `series` are present only for timeseries attributes,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    `data_type` is present only for plain and observations attributes.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="n">entity_type</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="n">attr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_spec_dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="p">}</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="k">for</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">entity_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.construct_entity_types" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">construct_entity_types</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.construct_entity_types" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">construct_entity_types</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Constructs entity ID type dictionary from model specification.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with entity ID types.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_entity_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Constructs entity ID type dictionary from model specification.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        Dictionary with entity ID types.</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">entity</span><span class="p">:</span> <span class="n">entity_spec</span><span class="o">.</span><span class="n">id_data_type</span><span class="o">.</span><span class="n">type_info</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">entity_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.await_updated" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">await_updated</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.await_updated" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">await_updated</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Checks whether schema saved in database is up-to-date and awaits its update
by the main worker on mismatch.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="k">def</span><span class="w"> </span><span class="nf">await_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a><span class="sd">    Checks whether schema saved in database is up-to-date and awaits its update</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">    by the main worker on mismatch.</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching current schema&quot;</span><span class="p">)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="n">schema_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_schema_doc</span><span class="p">()</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="k">for</span> <span class="n">delay</span> <span class="ow">in</span> <span class="n">RECONNECT_DELAYS</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="k">if</span> <span class="n">schema_doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="k">break</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema not found, will retry in </span><span class="si">%s</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">schema_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_schema_doc</span><span class="p">()</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="k">if</span> <span class="n">schema_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to establish schema&quot;</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="n">db_schema</span><span class="p">,</span> <span class="n">config_schema</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_status</span><span class="p">()</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>    <span class="k">for</span> <span class="n">delay</span> <span class="ow">in</span> <span class="n">RECONNECT_DELAYS</span><span class="p">:</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="k">if</span> <span class="n">db_schema</span> <span class="o">==</span> <span class="n">config_schema</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">break</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema mismatch, will await update by main worker in </span><span class="si">%s</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>        <span class="n">db_schema</span><span class="p">,</span> <span class="n">config_schema</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_status</span><span class="p">()</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">if</span> <span class="n">db_schema</span> <span class="o">!=</span> <span class="n">config_schema</span><span class="p">:</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to establish matching schema&quot;</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Schema OK!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.get_index_name_by_keys" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_index_name_by_keys</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.get_index_name_by_keys" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_index_name_by_keys</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Gets index name by keys.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>collection</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    Index name.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_index_name_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">    Gets index name by keys.</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">        collection: Collection name.</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">        keys: Index keys.</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">        Index name.</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">list_indexes</span><span class="p">():</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="k">if</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="k">return</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index not found for </span><span class="si">{</span><span class="n">collection</span><span class="si">}</span><span class="s2"> with keys </span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.update_storage" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">update_storage</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.update_storage" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">update_storage</span><span class="p">(</span><span class="n">prev_storage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">curr_storage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Updates storage settings in schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prev_storage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Previous storage settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>curr_storage</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current storage settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_storage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">curr_storage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">    Updates storage settings in schema.</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">        prev_storage: Previous storage settings.</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">        curr_storage: Current storage settings.</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating storage settings&quot;</span><span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="k">if</span> <span class="n">prev_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>            <span class="s2">&quot;Snapshot bucket size changed: </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="n">prev_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>            <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="p">)</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>            <span class="n">snapshot_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2">#snapshots&quot;</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>            <span class="c1"># Bucket size decreased, fix indexes before updating</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="k">if</span> <span class="n">prev_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fix_latest_bucket_index</span><span class="p">(</span><span class="n">snapshot_col</span><span class="p">,</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">])</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">snapshot_col</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>                <span class="p">{</span><span class="s2">&quot;oversized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]}},</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="c1"># Bucket size increased, fix indexes after updating</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="k">if</span> <span class="n">prev_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fix_latest_bucket_index</span><span class="p">(</span><span class="n">snapshot_col</span><span class="p">,</span> <span class="n">curr_storage</span><span class="p">[</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.migrate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">migrate</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">migrate</span><span class="p">(</span><span class="n">schema_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Migrates schema to the latest version.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema_doc</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema to migrate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    Migrated schema.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="k">def</span><span class="w"> </span><span class="nf">migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">    Migrates schema to the latest version.</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">        schema_doc: Schema to migrate.</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">        Migrated schema.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="k">if</span> <span class="n">schema_doc</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">SCHEMA_VERSION</span><span class="p">:</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="k">return</span> <span class="n">schema_doc</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">schema_doc</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">SCHEMA_VERSION</span><span class="p">):</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Migrating schema from version </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="n">schema_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">[</span><span class="n">version</span><span class="p">](</span><span class="n">schema_doc</span><span class="p">)</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">schema_doc</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>    <span class="k">return</span> <span class="n">schema_doc</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_2_to_3" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">migrate_schema_2_to_3</span>


<a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_2_to_3" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">migrate_schema_2_to_3</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Migrates schema from version 2 to version 3.</p>
<p>This migration adds the storage setting for snapshot bucket size to the schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema to migrate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    Migrated schema.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="k">def</span><span class="w"> </span><span class="nf">migrate_schema_2_to_3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">    Migrates schema from version 2 to version 3.</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">    This migration adds the storage setting for snapshot bucket size to the schema.</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        schema: Schema to migrate.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">        Migrated schema.</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>    <span class="c1"># Set created time for all snapshots, append last to history</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>    <span class="n">bucket_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;database.storage.snapshot_bucket_size&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_spec</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Migrating </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="n">snapshot_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2">#snapshots&quot;</span><span class="p">]</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2">#snapshots&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;_#\d+$&quot;</span><span class="p">}}}</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>        <span class="p">):</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>            <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oversized&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                <span class="n">ctime</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_time_created&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                <span class="n">snapshot_col</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                    <span class="p">[</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                        <span class="n">InsertOne</span><span class="p">(</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                            <span class="p">{</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                                <span class="o">**</span><span class="n">doc</span><span class="p">,</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_#</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                                <span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="n">ctime</span><span class="p">,</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                            <span class="p">}</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                        <span class="p">),</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                        <span class="n">DeleteOne</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]}),</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                    <span class="p">]</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="p">)</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                <span class="k">continue</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>            <span class="n">to_insert</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>            <span class="k">for</span> <span class="n">snapshot_bucket</span> <span class="ow">in</span> <span class="n">batched</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">],</span> <span class="n">bucket_size</span><span class="p">):</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                <span class="n">ctime</span> <span class="o">=</span> <span class="n">snapshot_bucket</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                    <span class="s2">&quot;_time_created&quot;</span><span class="p">,</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                <span class="p">)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                <span class="n">to_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                    <span class="p">{</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_#</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                        <span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="n">snapshot_bucket</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                        <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">snapshot_bucket</span><span class="p">,</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>                        <span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="n">ctime</span><span class="p">,</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_bucket</span><span class="p">),</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>                        <span class="s2">&quot;oversized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>                    <span class="p">}</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>                <span class="p">)</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>            <span class="n">snapshot_col</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">to_insert</span><span class="p">)</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>            <span class="n">snapshot_col</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]})</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>    <span class="c1"># Update schema</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;snapshot_bucket_size&quot;</span><span class="p">:</span> <span class="n">bucket_size</span><span class="p">}</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>    <span class="k">return</span> <span class="n">schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_3_to_4" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">migrate_schema_3_to_4</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#dp3.database.schema_cleaner.SchemaCleaner.migrate_schema_3_to_4" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">migrate_schema_3_to_4</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Migrates schema from version 3 to version 4.</p>
<p>This migration adds eid_data_type specification to the schema.
As all entities were previously using string as their entity ID type,
this is merely an accounting change.
Actual data types are to be changed by following migrations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema to migrate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    Migrated schema.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/schema_cleaner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="k">def</span><span class="w"> </span><span class="nf">migrate_schema_3_to_4</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">    Migrates schema from version 3 to version 4.</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">    This migration adds eid_data_type specification to the schema.</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="sd">    As all entities were previously using string as their entity ID type,</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">    this is merely an accounting change.</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">    Actual data types are to be changed by following migrations.</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        schema: Schema to migrate.</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        Migrated schema.</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>    <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;entity_id_types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]}</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>    <span class="k">return</span> <span class="n">schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>