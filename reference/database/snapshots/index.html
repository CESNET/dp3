
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Dynamic Profile Processing Platform">
      
      
      
        <link rel="canonical" href="https://cesnet.github.io/dp3/reference/database/snapshots/">
      
      
        <link rel="prev" href="../schema_cleaner/">
      
      
        <link rel="next" href="../../history_management/">
      
      
      <link rel="icon" href="../../../img/dp3-favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>snapshots - DP3</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/slate.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dp3.database.snapshots" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DP3" class="md-header__button md-logo" aria-label="DP3" data-md-component="logo">
      
  <img src="../../../img/dp3-logo-min.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DP3
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              snapshots
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/CESNET/dp3" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    CESNET/dp3
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="DP3" class="md-nav__button md-logo" aria-label="DP3" data-md-component="logo">
      
  <img src="../../../img/dp3-logo-min.svg" alt="logo">

    </a>
    DP3
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CESNET/dp3" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    CESNET/dp3
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../history_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History Management
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../configuration/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/db_entities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database entities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/lifetimes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entity Lifetimes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/event_logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/history_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/processing_core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Processing core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/garbage_collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Garbage Collector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Updater
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Code Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    dp3
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            dp3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    api
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1" id="__nav_9_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1">
            <span class="md-nav__icon md-icon"></span>
            api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/internal/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    internal
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1_1" id="__nav_9_1_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            internal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/dp_logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dp_logger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/entity_response_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entity_response_models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/internal/response_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    response_models
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    main
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api/routers/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    routers
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_1_3" id="__nav_9_1_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            routers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/entity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/root/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    root
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/routers/telemetry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    telemetry
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../bin/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    bin
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_2" id="__nav_9_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_2">
            <span class="md-nav__icon md-icon"></span>
            bin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    api
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/check/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    check
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/schema_update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    schema_update
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bin/worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    worker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../common/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    common
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_3" id="__nav_9_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_3">
            <span class="md-nav__icon md-icon"></span>
            common
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/attrspec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    attrspec
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/base_module/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    base_module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/callback_registrar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    callback_registrar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/datapoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datapoint
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/datatype/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datatype
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/entityspec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    entityspec
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/mac_address/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mac_address
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/scheduler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    scheduler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/task/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../core/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    core
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_4" id="__nav_9_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_4">
            <span class="md-nav__icon md-icon"></span>
            core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/collector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    collector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/link_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    link_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    updater
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    database
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_5" id="__nav_9_1_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1_5">
            <span class="md-nav__icon md-icon"></span>
            database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../encodings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    encodings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../magic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    magic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schema_cleaner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    schema_cleaner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    snapshots
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    snapshots
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection" class="md-nav__link">
    <span class="md-ellipsis">
      TypedSnapshotCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TypedSnapshotCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest_one" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.find_latest" class="md-nav__link">
    <span class="md-ellipsis">
      find_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.count_latest" class="md-nav__link">
    <span class="md-ellipsis">
      count_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_by_eid" class="md-nav__link">
    <span class="md-ellipsis">
      get_by_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_distinct_val_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_distinct_val_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.save_one" class="md-nav__link">
    <span class="md-ellipsis">
      save_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.save_many" class="md-nav__link">
    <span class="md-ellipsis">
      save_many
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_old" class="md-nav__link">
    <span class="md-ellipsis">
      delete_old
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eid" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eids" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eids
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.BinaryEidSnapshots" class="md-nav__link">
    <span class="md-ellipsis">
      BinaryEidSnapshots
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer" class="md-nav__link">
    <span class="md-ellipsis">
      SnapshotCollectionContainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SnapshotCollectionContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_one" class="md-nav__link">
    <span class="md-ellipsis">
      save_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_many" class="md-nav__link">
    <span class="md-ellipsis">
      save_many
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest_one" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.find_latest" class="md-nav__link">
    <span class="md-ellipsis">
      find_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.count_latest" class="md-nav__link">
    <span class="md-ellipsis">
      count_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_by_eid" class="md-nav__link">
    <span class="md-ellipsis">
      get_by_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_distinct_val_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_distinct_val_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_old" class="md-nav__link">
    <span class="md-ellipsis">
      delete_old
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eid" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eids" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eids
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../history_management/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    history_management
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_6" id="__nav_9_1_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6">
            <span class="md-nav__icon md-icon"></span>
            history_management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../history_management/history_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    history_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../history_management/telemetry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    telemetry
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../scripts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    scripts
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_7" id="__nav_9_1_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_7">
            <span class="md-nav__icon md-icon"></span>
            scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/add_hashes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    add_hashes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/add_min_t2s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    add_min_t2s
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/datapoint_log_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    datapoint_log_converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/dummy_sender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dummy_sender
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/migrate_snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    migrate_snapshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/script_runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    script_runner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../snapshots/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    snapshots
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_8" id="__nav_9_1_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_8">
            <span class="md-nav__icon md-icon"></span>
            snapshots
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snapshots/snapshooter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snapshooter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snapshots/snapshot_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    snapshot_hooks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../task_processing/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    task_processing
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9_1_9" id="__nav_9_1_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_9">
            <span class="md-nav__icon md-icon"></span>
            task_processing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_distributor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_distributor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_executor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_hooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_processing/task_queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    task_queue
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    worker
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scripts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../grafana_plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grafana plugin
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extending Documentation
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection" class="md-nav__link">
    <span class="md-ellipsis">
      TypedSnapshotCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TypedSnapshotCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest_one" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.find_latest" class="md-nav__link">
    <span class="md-ellipsis">
      find_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.count_latest" class="md-nav__link">
    <span class="md-ellipsis">
      count_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_by_eid" class="md-nav__link">
    <span class="md-ellipsis">
      get_by_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.get_distinct_val_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_distinct_val_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.save_one" class="md-nav__link">
    <span class="md-ellipsis">
      save_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.save_many" class="md-nav__link">
    <span class="md-ellipsis">
      save_many
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_old" class="md-nav__link">
    <span class="md-ellipsis">
      delete_old
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eid" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eids" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eids
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.BinaryEidSnapshots" class="md-nav__link">
    <span class="md-ellipsis">
      BinaryEidSnapshots
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer" class="md-nav__link">
    <span class="md-ellipsis">
      SnapshotCollectionContainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SnapshotCollectionContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_one" class="md-nav__link">
    <span class="md-ellipsis">
      save_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_many" class="md-nav__link">
    <span class="md-ellipsis">
      save_many
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest_one" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest_one
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest" class="md-nav__link">
    <span class="md-ellipsis">
      get_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.find_latest" class="md-nav__link">
    <span class="md-ellipsis">
      find_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.count_latest" class="md-nav__link">
    <span class="md-ellipsis">
      count_latest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_by_eid" class="md-nav__link">
    <span class="md-ellipsis">
      get_by_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_distinct_val_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_distinct_val_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_old" class="md-nav__link">
    <span class="md-ellipsis">
      delete_old
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eid" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eids" class="md-nav__link">
    <span class="md-ellipsis">
      delete_eids
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div class="doc doc-object doc-module">



<h1 id="dp3.database.snapshots" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">dp3.database.snapshots</span>


<a href="#dp3.database.snapshots" class="headerlink" title="Permanent link">&para;</a></h1>

    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="dp3.database.snapshots.TypedSnapshotCollection" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">TypedSnapshotCollection</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">TypedSnapshotCollection</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span> <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" title="abc.ABC" href="https://docs.python.org/3/library/abc.html#abc.ABC">ABC</a></code></p>


        <p>Snapshot collection handler with eid type awareness.</p>







                  <details class="quote">
                    <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="p">):</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">codec_options</span><span class="o">=</span><span class="n">get_codec_options</span><span class="p">())</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">if</span> <span class="n">entity_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity type &#39;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">&#39; not found in model spec&quot;</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="n">entity_type</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">#snapshots&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_os_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">#oversized_snapshots&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">attr_specs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttrSpecType</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">entity_attributes</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EntityDatabase.SnapshotCollection[</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_normal_snapshot_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_oversized_snapshot_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">snapshot_bucket_size</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_bucket_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot_bucket_delta</span><span class="p">(</span><span class="n">snapshots_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.get_latest_one" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_latest_one</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest_one" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_latest_one</span><span class="p">(</span><span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get latest snapshot of given eid.</p>
<p>If doesn't exist, returns {}.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_latest_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get latest snapshot of given eid.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    If doesn&#39;t exist, returns {}.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.get_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_latest</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.get_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get latest snapshots of given <code>etype</code>.</p>
<p>This method is useful for displaying data on web.</p>
<p>Returns only documents matching <code>generic_filter</code> and <code>fulltext_filters</code>
(dictionary attribute - fulltext filter).
Fulltext filters are interpreted as regular expressions.
Only string values may be filtered this way. There's no validation that queried attribute
can be fulltext filtered.
Only plain and observation attributes with string-based data types can be queried.
Array and set data types are supported as well as long as they are not multi value
at the same time.
If you need to filter EIDs, ensure the EID is string, then use attribute <code>eid</code>.
Otherwise, use generic filter.</p>
<p>Generic filter allows filtering using generic MongoDB query (including <code>$and</code>, <code>$or</code>,
<code>$lt</code>, etc.).
For querying non-JSON-native types, you can use magic strings, such as
<code>"$$IPv4{&lt;ip address&gt;}"</code> for IPv4 addresses. The full spec with examples is in the
<a class="autorefs autorefs-internal" title="dp3.database.magic" href="../magic/#dp3.database.magic">magic strings module</a>.</p>
<p>Generic and fulltext filters are merged - fulltext overrides conflicting keys.</p>
<p>Also returns total document count (after filtering).</p>
<p>May raise <code>SnapshotCollectionError</code> if query is invalid.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_latest</span><span class="p">(</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get latest snapshots of given `etype`.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    This method is useful for displaying data on web.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Returns only documents matching `generic_filter` and `fulltext_filters`</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    (dictionary attribute - fulltext filter).</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    Fulltext filters are interpreted as regular expressions.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Only string values may be filtered this way. There&#39;s no validation that queried attribute</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    can be fulltext filtered.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Only plain and observation attributes with string-based data types can be queried.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    Array and set data types are supported as well as long as they are not multi value</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    at the same time.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    If you need to filter EIDs, ensure the EID is string, then use attribute `eid`.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    Otherwise, use generic filter.</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">    Generic filter allows filtering using generic MongoDB query (including `$and`, `$or`,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    `$lt`, etc.).</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    For querying non-JSON-native types, you can use magic strings, such as</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    `&quot;$$IPv4{&lt;ip address&gt;}&quot;` for IPv4 addresses. The full spec with examples is in the</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    [magic strings module][dp3.database.magic].</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    Generic and fulltext filters are merged - fulltext overrides conflicting keys.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    Also returns total document count (after filtering).</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    May raise `SnapshotCollectionError` if query is invalid.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">snapshot_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_latest_query</span><span class="p">(</span><span class="n">fulltext_filters</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">generic_filter</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">return</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="p">[(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)]</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="p">),</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">except</span> <span class="n">OperationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query is invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.find_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">find_latest</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.find_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">find_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Find latest snapshots of given <code>etype</code>.</p>
<p>See <a class="autorefs autorefs-internal" title="get_latest" href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest"><code>get_latest</code></a>
for more information.</p>
<p>Returns only documents matching <code>generic_filter</code> and <code>fulltext_filters</code>,
does not count them.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_latest</span><span class="p">(</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find latest snapshots of given `etype`.</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    See [`get_latest`][dp3.database.snapshots.SnapshotCollectionContainer.get_latest]</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    for more information.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    Returns only documents matching `generic_filter` and `fulltext_filters`,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">    does not count them.</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_latest_query</span><span class="p">(</span><span class="n">fulltext_filters</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">generic_filter</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)])</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">except</span> <span class="n">OperationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query is invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.count_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">count_latest</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.count_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">count_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Count latest snapshots of given <code>etype</code>.</p>
<p>See <a class="autorefs autorefs-internal" title="get_latest" href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest"><code>get_latest</code></a>
for more information.</p>
<p>Returns only count of documents matching <code>generic_filter</code> and <code>fulltext_filters</code>.</p>
<p>Note that this method may take much longer than <code>get_latest</code> on larger databases,
as it does count all documents, not just return the first few.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_latest</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Count latest snapshots of given `etype`.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">    See [`get_latest`][dp3.database.snapshots.SnapshotCollectionContainer.get_latest]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    for more information.</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">    Returns only count of documents matching `generic_filter` and `fulltext_filters`.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">    Note that this method may take much longer than `get_latest` on larger databases,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">    as it does count all documents, not just return the first few.</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_latest_query</span><span class="p">(</span><span class="n">fulltext_filters</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">generic_filter</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">except</span> <span class="n">OperationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query is invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.get_by_eid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_by_eid</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.get_by_eid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_by_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all (or filtered) snapshots of given <code>eid</code>.</p>
<p>This method is useful for displaying <code>eid</code>'s history on web.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>eid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnyEidT


  
      module-attribute
   (dp3.common.datatype.AnyEidT)" href="../../common/datatype/#dp3.common.datatype.AnyEidT">AnyEidT</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>id of entity, to which data-points correspond</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>left value of time interval (inclusive)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>right value of time interval (inclusive)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_by_eid</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">]:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all (or filtered) snapshots of given `eid`.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    This method is useful for displaying `eid`&#39;s history on web.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        eid: id of entity, to which data-points correspond</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        t1: left value of time interval (inclusive)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        t2: right value of time interval (inclusive)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="n">snapshot_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="c1"># Find out if the snapshot is oversized</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">snapshot_col</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;oversized&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="k">if</span> <span class="n">doc</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oversized&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oversized</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)},</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$history&quot;</span><span class="p">},</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="p">{</span><span class="s2">&quot;$replaceRoot&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;newRoot&quot;</span><span class="p">:</span> <span class="s2">&quot;$history&quot;</span><span class="p">}},</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="p">]</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="c1"># Filter by date</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="k">if</span> <span class="n">t1</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">][</span><span class="s2">&quot;$gte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">if</span> <span class="n">t2</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">][</span><span class="s2">&quot;$lte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="c1"># Unset if empty</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">}})</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="k">return</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.get_distinct_val_count" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_distinct_val_count</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.get_distinct_val_count" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_distinct_val_count</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Counts occurrences of distinct values of given attribute in snapshots.</p>
<p>Returns dictionary mapping value -&gt; count.</p>
<p>Works for all plain and observation data types except <code>dict</code> and <code>json</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_distinct_val_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Counts occurrences of distinct values of given attribute in snapshots.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    Returns dictionary mapping value -&gt; count.</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    Works for all plain and observation data types except `dict` and `json`.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="c1"># Get attribute specification</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">attr_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_specs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="k">if</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">PLAIN</span> <span class="o">|</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">OBSERVATIONS</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; isn&#39;t plain or observations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="c1"># Attribute data type must be primitive, array&lt;T&gt; or set&lt;T&gt;</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">needle</span> <span class="ow">in</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">needle</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="sa">f</span><span class="s2">&quot;Data type &#39;</span><span class="si">{</span><span class="n">attr_spec</span><span class="o">.</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&#39; of attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; is not processable&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="c1"># Build aggregation query</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="n">attr_path</span> <span class="o">=</span> <span class="s2">&quot;$last.&quot;</span> <span class="o">+</span> <span class="n">attr</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">unwinding</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="c1"># Unwind array-like and multi value attributes</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="c1"># If attribute is multi value array, unwind twice</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">if</span> <span class="s2">&quot;array&quot;</span> <span class="ow">in</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">root</span> <span class="ow">or</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">unwinding</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="n">attr_path</span><span class="p">})</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="k">if</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="n">AttrType</span><span class="o">.</span><span class="n">OBSERVATIONS</span> <span class="ow">and</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">multi_value</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">unwinding</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="n">attr_path</span><span class="p">})</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="c1"># Group</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">agg_query_group_id</span> <span class="o">=</span> <span class="n">attr_path</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">if</span> <span class="s2">&quot;link&quot;</span> <span class="ow">in</span> <span class="n">attr_spec</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">agg_query_group_id</span> <span class="o">+=</span> <span class="s2">&quot;.eid&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">agg_query</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="o">*</span><span class="n">unwinding</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">agg_query_group_id</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="p">]</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="c1"># Run aggregation</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="n">distinct_counts_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">agg_query</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">distinct_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">distinct_counts_cur</span><span class="p">}</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">distinct_counts</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="k">del</span> <span class="n">distinct_counts</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="k">return</span> <span class="n">distinct_counts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.save_one" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_one</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.save_one" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_one</span><span class="p">(</span><span class="n">snapshot</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Saves snapshot to specified entity of current master document.</p>
<p>Will move snapshot to oversized snapshots if the maintained bucket is too large.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves snapshot to specified entity of current master document.</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="sd">    Will move snapshot to oversized snapshots if the maintained bucket is too large.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">if</span> <span class="s2">&quot;eid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Snapshot is missing &#39;eid&#39; field: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">return</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="n">eid</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="n">snapshot_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">os_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_col</span><span class="p">()</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="c1"># Find out if the snapshot is oversized</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">normal</span><span class="p">,</span> <span class="n">oversized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">({</span><span class="n">eid</span><span class="p">})</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="k">if</span> <span class="n">normal</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span><span class="p">}},</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="p">{</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                    <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="n">snapshot</span><span class="p">},</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                    <span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$each&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">snapshot</span><span class="p">],</span> <span class="s2">&quot;$position&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                    <span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                    <span class="s2">&quot;$setOnInsert&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket_id</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">ctime</span><span class="p">),</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                        <span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="n">ctime</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                        <span class="s2">&quot;oversized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                        <span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                    <span class="p">},</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                <span class="p">},</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="n">snapshot_col</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                    <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span><span class="p">},</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                    <span class="p">{</span><span class="s2">&quot;$unset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                <span class="p">)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">WriteError</span><span class="p">,</span> <span class="n">OperationFailure</span><span class="p">,</span> <span class="n">DocumentTooLarge</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">BSON_OBJECT_TOO_LARGE</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="c1"># The snapshot is too large, move it to oversized snapshots</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Snapshot of </span><span class="si">{</span><span class="n">eid</span><span class="si">}</span><span class="s2"> is too large: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, marking as oversized.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_to_oversized</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_snapshot_state</span><span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="n">normal</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="sa">f</span><span class="s2">&quot;Insert of snapshot </span><span class="si">{</span><span class="n">eid</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">snapshot</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="k">return</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="k">elif</span> <span class="n">oversized</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="c1"># Snapshot is already marked as oversized</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">snapshot_col</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="n">snapshot</span><span class="p">}})</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">os_col</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.save_many" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_many</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.save_many" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_many</span><span class="p">(</span><span class="n">snapshots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Saves a list of snapshots of current master documents.</p>
<p>All snapshots must belong to same entity type.</p>
<p>Will move snapshots to oversized snapshots if the maintained bucket is too large.
For better understanding, see <code>save()</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="sd">    Saves a list of snapshots of current master documents.</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    All snapshots must belong to same entity type.</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">    Will move snapshots to oversized snapshots if the maintained bucket is too large.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">    For better understanding, see `save()`.</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>    <span class="n">snapshot_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>    <span class="n">os_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_col</span><span class="p">()</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="n">snapshots_by_eid</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="k">if</span> <span class="s2">&quot;eid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="k">continue</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">del</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;eid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="c1"># Find out if any of the snapshots are oversized</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="n">normal</span><span class="p">,</span> <span class="n">oversized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">snapshots_by_eid</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">upserts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="n">update_originals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="n">oversized_inserts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="n">oversized_updates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="c1"># A normal snapshot, shift the last snapshot to history and update last</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">normal</span><span class="p">:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="n">upserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="n">UpdateOne</span><span class="p">(</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span><span class="p">}},</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                <span class="p">{</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>                    <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]},</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                    <span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$each&quot;</span><span class="p">:</span> <span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">],</span> <span class="s2">&quot;$position&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>                    <span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">])},</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>                    <span class="s2">&quot;$setOnInsert&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket_id</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">ctime</span><span class="p">),</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>                        <span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="n">ctime</span><span class="p">,</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                        <span class="s2">&quot;oversized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                        <span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                    <span class="p">},</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                <span class="p">},</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="p">)</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="p">)</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="n">update_originals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">])</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="c1"># Snapshot is already marked as oversized</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>    <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">oversized</span><span class="p">:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">oversized_inserts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">])</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">oversized_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">UpdateOne</span><span class="p">(</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">),</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="n">snapshots_by_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]}},</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="p">)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="n">new_oversized</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="k">if</span> <span class="n">upserts</span><span class="p">:</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">upserts</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="c1"># Unset latest snapshots if new snapshots were inserted</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="n">unset_latest_updates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                <span class="k">for</span> <span class="n">upsert_id</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_ids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                    <span class="n">unset_latest_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                        <span class="n">UpdateMany</span><span class="p">(</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_bid</span><span class="p">(</span><span class="n">upsert_id</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                            <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span><span class="p">},</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                            <span class="p">{</span><span class="s2">&quot;$unset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                        <span class="p">)</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                    <span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                <span class="n">up_res</span> <span class="o">=</span> <span class="n">snapshot_col</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">unset_latest_updates</span><span class="p">)</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="k">if</span> <span class="n">up_res</span><span class="o">.</span><span class="n">modified_count</span> <span class="o">!=</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_count</span><span class="p">:</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                        <span class="s2">&quot;Upserted the first snapshot for </span><span class="si">%d</span><span class="s2"> entities.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>                        <span class="n">res</span><span class="o">.</span><span class="n">upserted_count</span> <span class="o">-</span> <span class="n">up_res</span><span class="o">.</span><span class="n">modified_count</span><span class="p">,</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>                    <span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">modified_count</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">upserts</span><span class="p">):</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                    <span class="s2">&quot;Some snapshots were not updated, </span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>                    <span class="n">res</span><span class="o">.</span><span class="n">modified_count</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">upserted_count</span><span class="p">,</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">upserts</span><span class="p">),</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                <span class="p">)</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">BulkWriteError</span><span class="p">,</span> <span class="n">OperationFailure</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update of snapshots failed, will retry with oversize.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">failed_indexes</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="n">err</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;writeErrors&quot;</span><span class="p">]</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                <span class="k">if</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">BSON_OBJECT_TOO_LARGE</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="p">]</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>            <span class="n">failed_snapshots</span> <span class="o">=</span> <span class="p">(</span><span class="n">update_originals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">failed_indexes</span><span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="k">for</span> <span class="n">eid_snapshots</span> <span class="ow">in</span> <span class="n">failed_snapshots</span><span class="p">:</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="n">eid</span> <span class="o">=</span> <span class="n">eid_snapshots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;eid&quot;</span><span class="p">]</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="n">failed_snapshots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                    <span class="n">eid_snapshots</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;_time_created&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                <span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_to_oversized</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">failed_snapshots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                <span class="n">oversized_inserts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">failed_snapshots</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                <span class="n">new_oversized</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BSON_OBJECT_TOO_LARGE</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;writeErrors&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                <span class="c1"># Some other error occurred</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upsert of snapshots failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">2048</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="c1"># Update the oversized snapshots</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="k">if</span> <span class="n">oversized_inserts</span><span class="p">:</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>            <span class="k">if</span> <span class="n">oversized_updates</span><span class="p">:</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                <span class="n">snapshot_col</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">oversized_updates</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>            <span class="n">os_col</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">oversized_inserts</span><span class="p">)</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>            <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insert of snapshots failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">2048</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>    <span class="c1"># Cache the new state</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_snapshot_state</span><span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="n">new_oversized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.delete_old" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_old</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_old" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_old</span><span class="p">(</span><span class="n">t_old</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete old snapshots.</p>
<p>Periodically called from HistoryManager.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_old</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete old snapshots.</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">    Periodically called from HistoryManager.</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>    <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>            <span class="p">{</span><span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lte&quot;</span><span class="p">:</span> <span class="n">t_old</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket_delta</span><span class="p">}},</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="p">)</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="n">deleted</span> <span class="o">+=</span> <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s2">&quot;_time_created&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">t_old</span><span class="p">}})</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="n">deleted</span> <span class="o">+=</span> <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete of olds snapshots failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="k">return</span> <span class="n">deleted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.delete_eid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_eid</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete all snapshots of <code>eid</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_eid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">):</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete all snapshots of `eid`.&quot;&quot;&quot;</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">))</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>        <span class="n">del_cnt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;deleted </span><span class="si">%s</span><span class="s2"> snapshots of </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">del_cnt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span><span class="p">,</span> <span class="n">eid</span><span class="p">)</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s2">&quot;eid&quot;</span><span class="p">:</span> <span class="n">eid</span><span class="p">})</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="s2">&quot;Deleted </span><span class="si">%s</span><span class="s2"> oversized snapshots of </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span><span class="p">,</span> <span class="n">eid</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>        <span class="p">)</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete of failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">eid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.TypedSnapshotCollection.delete_eids" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_eids</span>


<a href="#dp3.database.snapshots.TypedSnapshotCollection.delete_eids" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_eids</span><span class="p">(</span><span class="n">eids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete all snapshots of <code>eids</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_eids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete all snapshots of `eids`.&quot;&quot;&quot;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_from_eids</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="n">del_cnt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleted </span><span class="si">%s</span><span class="s2"> snapshots of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">del_cnt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_col</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s2">&quot;eid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">eids</span><span class="p">}})</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>            <span class="s2">&quot;Deleted </span><span class="si">%s</span><span class="s2"> oversized snapshots of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">,</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>            <span class="n">res</span><span class="o">.</span><span class="n">deleted_count</span><span class="p">,</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span><span class="p">,</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="p">)</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete of snapshots failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">eids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="dp3.database.snapshots.BinaryEidSnapshots" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">BinaryEidSnapshots</span>


<a href="#dp3.database.snapshots.BinaryEidSnapshots" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">BinaryEidSnapshots</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span> <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TypedSnapshotCollection (dp3.database.snapshots.TypedSnapshotCollection)" href="#dp3.database.snapshots.TypedSnapshotCollection">TypedSnapshotCollection</a></code>, <code><a class="autorefs autorefs-external" title="abc.ABC" href="https://docs.python.org/3/library/abc.html#abc.ABC">ABC</a></code></p>








                  <details class="quote">
                    <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="p">):</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">codec_options</span><span class="o">=</span><span class="n">get_codec_options</span><span class="p">())</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">if</span> <span class="n">entity_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity type &#39;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">&#39; not found in model spec&quot;</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">entity_type</span> <span class="o">=</span> <span class="n">entity_type</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">#snapshots&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_os_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">#oversized_snapshots&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">attr_specs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AttrSpecType</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">entity_attributes</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EntityDatabase.SnapshotCollection[</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_normal_snapshot_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_oversized_snapshot_eids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_bucket_size</span> <span class="o">=</span> <span class="n">db_config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">snapshot_bucket_size</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_bucket_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot_bucket_delta</span><span class="p">(</span><span class="n">snapshots_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="dp3.database.snapshots.SnapshotCollectionContainer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SnapshotCollectionContainer</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">SnapshotCollectionContainer</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span> <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


        <p>Container for all required snapshot collections, exposing the public interface.</p>







                  <details class="quote">
                    <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">db_config</span><span class="p">:</span> <span class="n">MongoConfig</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">:</span> <span class="n">ModelSpec</span><span class="p">,</span> <span class="n">snapshots_config</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="p">):</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_collections</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="k">for</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_spec</span> <span class="ow">in</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>        <span class="n">eid_type_name</span> <span class="o">=</span> <span class="n">entity_spec</span><span class="o">.</span><span class="n">id_data_type</span><span class="o">.</span><span class="n">root</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>        <span class="n">typed_collection</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">TypedSnapshotCollection</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_type2collection</span><span class="p">[</span><span class="n">eid_type_name</span><span class="p">]</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_collections</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">typed_collection</span><span class="p">(</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>            <span class="n">db</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">db_config</span><span class="p">,</span> <span class="n">model_spec</span><span class="p">,</span> <span class="n">snapshots_config</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="p">)</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;EntityDatabase.SnapshotCollections&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.save_one" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_one</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_one" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_one</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Save snapshot to specified entity of current master document.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-768" name="__codelineno-0-768"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save snapshot to specified entity of current master document.&quot;&quot;&quot;</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">save_one</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.save_many" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_many</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.save_many" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_many</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Saves a list of snapshots of current master documents.</p>
<p>All snapshots must belong to same entity type.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">ctime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><span class="sd">    Saves a list of snapshots of current master documents.</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="sd">    All snapshots must belong to same entity type.</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">save_many</span><span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.get_latest_one" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_latest_one</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest_one" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_latest_one</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get latest snapshot of given eid.</p>
<p>If doesn't exist, returns {}.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_latest_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get latest snapshot of given eid.</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a><span class="sd">    If doesn&#39;t exist, returns {}.</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">get_latest_one</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.get_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_latest</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_latest</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get latest snapshots of given <code>etype</code>.</p>
<p>This method is useful for displaying data on web.</p>
<p>Returns only documents matching <code>generic_filter</code> and <code>fulltext_filters</code>
(dictionary attribute - fulltext filter).
Fulltext filters are interpreted as regular expressions.
Only string values may be filtered this way. There's no validation that queried attribute
can be fulltext filtered.
Only plain and observation attributes with string-based data types can be queried.
Array and set data types are supported as well as long as they are not multi value
at the same time.
If you need to filter EIDs, ensure the EID is string, then use attribute <code>eid</code>.
Otherwise, use generic filter.</p>
<p>Generic filter allows filtering using generic MongoDB query (including <code>$and</code>, <code>$or</code>,
<code>$lt</code>, etc.).
For querying non-JSON-native types, you can use magic strings, such as
<code>"$$IPv4{&lt;ip address&gt;}"</code> for IPv4 addresses. The full spec with examples is in the
<a class="autorefs autorefs-internal" title="dp3.database.magic" href="../magic/#dp3.database.magic">magic strings module</a>.</p>
<p>Generic and fulltext filters are merged - fulltext overrides conflicting keys.</p>
<p>Also returns total document count (after filtering).</p>
<p>May raise <code>SnapshotCollectionError</code> if query is invalid.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-787" name="__codelineno-0-787"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_latest</span><span class="p">(</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get latest snapshots of given `etype`.</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a><span class="sd">    This method is useful for displaying data on web.</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a><span class="sd">    Returns only documents matching `generic_filter` and `fulltext_filters`</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a><span class="sd">    (dictionary attribute - fulltext filter).</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a><span class="sd">    Fulltext filters are interpreted as regular expressions.</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a><span class="sd">    Only string values may be filtered this way. There&#39;s no validation that queried attribute</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a><span class="sd">    can be fulltext filtered.</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a><span class="sd">    Only plain and observation attributes with string-based data types can be queried.</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a><span class="sd">    Array and set data types are supported as well as long as they are not multi value</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a><span class="sd">    at the same time.</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a><span class="sd">    If you need to filter EIDs, ensure the EID is string, then use attribute `eid`.</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a><span class="sd">    Otherwise, use generic filter.</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a><span class="sd">    Generic filter allows filtering using generic MongoDB query (including `$and`, `$or`,</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a><span class="sd">    `$lt`, etc.).</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">    For querying non-JSON-native types, you can use magic strings, such as</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="sd">    `&quot;$$IPv4{&lt;ip address&gt;}&quot;` for IPv4 addresses. The full spec with examples is in the</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a><span class="sd">    [magic strings module][dp3.database.magic].</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="sd">    Generic and fulltext filters are merged - fulltext overrides conflicting keys.</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">    Also returns total document count (after filtering).</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a><span class="sd">    May raise `SnapshotCollectionError` if query is invalid.</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.find_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">find_latest</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.find_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">find_latest</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Find latest snapshots of given <code>etype</code>.</p>
<p>see <a class="autorefs autorefs-internal" title="get_latest" href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest"><code>get_latest</code></a>
for more information.</p>
<p>Returns only documents matching <code>generic_filter</code> and <code>fulltext_filters</code>,
does not count them.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-822" name="__codelineno-0-822"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_latest</span><span class="p">(</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cursor</span><span class="p">:</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find latest snapshots of given `etype`.</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a><span class="sd">    see [`get_latest`][dp3.database.snapshots.SnapshotCollectionContainer.get_latest]</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="sd">    for more information.</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a><span class="sd">    Returns only documents matching `generic_filter` and `fulltext_filters`,</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a><span class="sd">    does not count them.</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">find_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.count_latest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">count_latest</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.count_latest" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">count_latest</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Count latest snapshots of given <code>etype</code>.</p>
<p>see <a class="autorefs autorefs-internal" title="get_latest" href="#dp3.database.snapshots.SnapshotCollectionContainer.get_latest"><code>get_latest</code></a>
for more information.</p>
<p>Returns only count of documents matching <code>generic_filter</code> and <code>fulltext_filters</code>.</p>
<p>Note that this method may take much longer than <code>get_latest</code> on larger databases,
as it does count all documents, not just return the first few.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-838" name="__codelineno-0-838"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_latest</span><span class="p">(</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>    <span class="n">fulltext_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>    <span class="n">generic_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Count latest snapshots of given `etype`.</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="sd">    see [`get_latest`][dp3.database.snapshots.SnapshotCollectionContainer.get_latest]</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a><span class="sd">    for more information.</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="sd">    Returns only count of documents matching `generic_filter` and `fulltext_filters`.</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a><span class="sd">    Note that this method may take much longer than `get_latest` on larger databases,</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="sd">    as it does count all documents, not just return the first few.</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">count_latest</span><span class="p">(</span><span class="n">fulltext_filters</span><span class="p">,</span> <span class="n">generic_filter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.get_by_eid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_by_eid</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_by_eid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_by_eid</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all (or filtered) snapshots of given <code>eid</code>.</p>
<p>This method is useful for displaying <code>eid</code>'s history on web.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>entity_type</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of entity type</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eid</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnyEidT


  
      module-attribute
   (dp3.common.datatype.AnyEidT)" href="../../common/datatype/#dp3.common.datatype.AnyEidT">AnyEidT</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>id of entity, to which data-points correspond</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t1</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>left value of time interval (inclusive)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t2</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="datetime.datetime" href="https://docs.python.org/3/library/datetime.html#datetime.datetime">datetime</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>right value of time interval (inclusive)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_by_eid</span><span class="p">(</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>    <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">,</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>    <span class="n">t1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>    <span class="n">t2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">]:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all (or filtered) snapshots of given `eid`.</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a><span class="sd">    This method is useful for displaying `eid`&#39;s history on web.</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a><span class="sd">        entity_type: name of entity type</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a><span class="sd">        eid: id of entity, to which data-points correspond</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a><span class="sd">        t1: left value of time interval (inclusive)</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a><span class="sd">        t2: right value of time interval (inclusive)</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.get_distinct_val_count" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_distinct_val_count</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.get_distinct_val_count" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_distinct_val_count</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Counts occurrences of distinct values of given attribute in snapshots.</p>
<p>Returns dictionary mapping value -&gt; count.</p>
<p>Works for all plain and observation data types except <code>dict</code> and <code>json</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-875" name="__codelineno-0-875"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_distinct_val_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Counts occurrences of distinct values of given attribute in snapshots.</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a><span class="sd">    Returns dictionary mapping value -&gt; count.</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a><span class="sd">    Works for all plain and observation data types except `dict` and `json`.</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">get_distinct_val_count</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.delete_old" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_old</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_old" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_old</span><span class="p">(</span><span class="n">t_old</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete old snapshots, may raise <code>SnapshotCollectionError</code>.</p>
<p>Periodically called from HistoryManager.
Returns:
     number of deleted snapshots.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_old</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete old snapshots, may raise `SnapshotCollectionError`.</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="sd">    Periodically called from HistoryManager.</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="sd">         number of deleted snapshots.</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>    <span class="n">deleted_total</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>    <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_collections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>            <span class="n">deleted_total</span> <span class="o">+=</span> <span class="n">collection</span><span class="o">.</span><span class="n">delete_old</span><span class="p">(</span><span class="n">t_old</span><span class="p">)</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>            <span class="k">raise</span> <span class="n">SnapshotCollectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete of old snapshots failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>    <span class="k">return</span> <span class="n">deleted_total</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.delete_eid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_eid</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_eid</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete snapshots of given <code>eids</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-899" name="__codelineno-0-899"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_eid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eid</span><span class="p">:</span> <span class="n">AnyEidT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete snapshots of given `eids`.&quot;&quot;&quot;</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">delete_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="dp3.database.snapshots.SnapshotCollectionContainer.delete_eids" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delete_eids</span>


<a href="#dp3.database.snapshots.SnapshotCollectionContainer.delete_eids" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">delete_eids</span><span class="p">(</span><span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Delete snapshots of given <code>eids</code>.</p>


            <details class="quote">
              <summary>Source code in <code>dp3/database/snapshots.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_eids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">eids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete snapshots of given `eids`.&quot;&quot;&quot;</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">entity_type</span><span class="p">]</span><span class="o">.</span><span class="n">delete_eids</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>